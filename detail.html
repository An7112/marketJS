<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="app.css">
    <link rel="stylesheet" type="text/css" href="./style/page1.css">
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" type="text/css" href="detail.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0" />
</head>

<body>
    <!-- Your detail page content here -->
    <div id="header">
        <div class="frame-menu-icon">
            <span class="material-symbols-outlined menu-icon" onclick="toggleSide()">
                menu
            </span>
        </div>
        <div class="frame-header">
            <div class="frame-input">
                <span class="material-symbols-outlined icon-search-header">
                    search
                </span>
                <input class='input-header' placeholder='Search or type a command' />
            </div>
            <div class='frame-info'>
                <div class='class-icon-header'>
                    <span class="material-symbols-outlined icon-header">
                        paid
                    </span>
                </div>
                <div class='class-icon-header'>
                    <span class="material-symbols-outlined icon-header">
                        shopping_cart
                    </span>
                    <p class='cart-count'>0</p>
                </div>
                <div class='class-avatar'>
                    <span class='span-frame'>
                        <img class='img-avatar' alt='user' src='/media/avatar.avif' />
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div id="sidebar" class="open">

    </div>

    <div id="detail-content" class="class-item open">

    </div>


    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const url = window.location.href;
            var questionMarkIndex = url.indexOf('?')
            var queryString = url.substring(questionMarkIndex + 1);
            var params = new URLSearchParams(queryString)
            var storeId = params.get("id")
            fetchDetailData(storeId)
                .then((data) => {
                    updateDetailContent(data);
                })
                .catch((error) => {
                    console.log(error);
                });
        });
        const addToCart = (item) => {
            const productsInCart = JSON.parse(localStorage.getItem('cart') || '[]');
            const productExists = productsInCart.some((product) => product._id === item._id);
            if (!productExists) {
                productsInCart.push(item);
                localStorage.setItem('cart', JSON.stringify(productsInCart));
            }
        };

        const removeFromCart = (item) => {
            const productsInCart = JSON.parse(localStorage.getItem('cart') || '[]');
            const productIndex = productsInCart.findIndex((product) => product._id === item._id);

            if (productIndex !== -1) {
                productsInCart.splice(productIndex, 1);
                localStorage.setItem('cart', JSON.stringify(productsInCart));
            }
        };


        function shoppingCart(button, item) {
            if (button.classList.contains('add-to-cart')) {
                button.classList.replace('add-to-cart', 'added-to-cart');
                addToCart(item);
            } else if (button.classList.contains('added-to-cart')) {
                button.classList.replace('added-to-cart', 'add-to-cart');
                removeFromCart(item);

            }
        }

        async function fetchDetailData(storeId) {
            const response = await fetch(`https://marketplace-3lqw.onrender.com/api/products?owner=${storeId}`)
            const data = await response.json();
            return data
        }


        function updateDetailContent(data) {
            // Update the DOM with the detail data
            const detailContent = document.getElementById('detail-content');

            const listItem = document.createElement('div')
            listItem.className = 'list-item'
            data.forEach((element) => {
                const storeItems = document.createElement('a');
                storeItems.href = `/product.html?storeId=${element.owner}&id=${element._id}`

                const item = document.createElement('div')
                item.className = 'item'

                const buttonCart = document.createElement('button')
                buttonCart.className =
                    localStorage.getItem('cart')
                        && JSON.parse(localStorage.getItem('cart')).some((product) => product._id === element._id)
                        ? 'added-to-cart'
                        : 'add-to-cart';
                buttonCart.onclick = function (event) {
                    event.preventDefault()
                    shoppingCart(this, element);
                };

                const frameIMG = document.createElement('div')
                frameIMG.className = 'frame-img'
                frameIMG.innerHTML = `<span class='span-frame'>
                      <img src='${element.productIMG}' class='product-img' alt='' />
                    </span>`

                const itemName = document.createElement('h5')
                itemName.className = 'item-name'
                itemName.textContent = element.productName

                const itemNameBlur = document.createElement('h5')
                itemNameBlur.className = 'item-name blur'
                itemNameBlur.textContent = element.owner

                const itemPrice = document.createElement('span')
                itemPrice.className = 'product-price'
                itemPrice.innerHTML = `<span class="material-symbols-outlined">
                                            finance_chip
                                        </span>
                                        ${element.productPrice}
                                        `
                item.appendChild(buttonCart)
                item.appendChild(frameIMG)
                item.appendChild(itemName)
                item.appendChild(itemNameBlur)
                item.appendChild(itemPrice)
                storeItems.appendChild(item)
                listItem.appendChild(storeItems)
            })

            detailContent.appendChild(listItem);
        }

        function toggleSide() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            var detail = document.querySelector('.class-item')
            console.log(detail.className)
            detail.classList.toggle('open')
        }

    </script>
    <script src="link.js"></script>
</body>

</html>